/**
  * clues.js (c) 2009-2013 Ziggy.jonsson.nyc@gmail.com
  * @license MIT
  */
(function(e){function t(e,r){return this instanceof t?(this.logic=e||("undefined"==typeof window?{}:window),this.facts=r||{},void 0):new t(e,r)}function r(e){var t=i.exec(""+e.prototype.constructor);return t[1].replace(/\s/g,"").split(",")}var n;"undefined"!=typeof module?(n=require("q"),module.exports=t):(n=e.Q,e.clues=t),t.version="0.0.7";var i=/function.*?\((.*?)\).*/;t.prototype.solve=function(e,t){var n,i=this,f=i.adapter,l=f.pending();if(t=t||{},"function"!=typeof e){if(n=e,t[n])return f.fulfilled(t[n]);if(void 0!==i.facts[n])return f.fulfilled(i.facts[n]);if(void 0===i.logic[n])return f.rejected({ref:n,err:"not defined"});if("function"!=typeof i.logic[n])return f.fulfilled(i.logic[n]);i.facts[n]=l.promise,l.promise.then(function(e){i.facts[n]=e}),e=i.logic[n]}var o={ref:n,self:i,local:t,facts:i.facts,promise:l.promise,fulfill:l.fulfill,reject:l.reject,callback:function(e,t){e?l.reject(e):l.fulfill(t)}};o.resolve=o.success=o.fulfill,o.error=o.reject;var c=r(e).filter(function(e){return e.length}).map(function(e){return"all"==e?i.all():o[e]||i.solve(e,t)});return this.join(c).then(function(){var t=i.wrap.call(o,e,c);void 0!==t&&(t.then?t.then(l.fulfill,l.reject):l.fulfill(t))}).then(null,function(e){l.reject(e)}),l.promise.then(null,function(e){throw e.message&&(e=e.message),e.ref||(e={ref:n,err:e}),e})},t.prototype.wrap=function(e,t){return e.apply(this,t)},t.prototype.all=function(e){var t,r=this;return t=Object.keys(r.logic).map(function(t){return r.solve(t,e)}),r.join.call(this,t).then(function(){return r.facts})},t.prototype.as=function(e){var t=this,r=t.adapter.pending();return t.facts[e]=r.promise,function(n,i){n?r.reject(n):r.fulfill(i),t.facts[e]=i}},"undefined"!==n&&(t.prototype.adapter={fulfilled:n.resolve,rejected:n.reject,pending:function(){var e=n.defer();return{promise:e.promise,fulfill:e.resolve,reject:e.reject}}}),t.prototype.join=function(e){var t=e.length,r=this.adapter.pending();return t||r.fulfill([]),e.forEach(function(n,i){return n.then?(n.then(function(n){return e[i]=n,!(t-=1)&&r.fulfill(e)},r.reject),void 0):!(t-=1)&&r.fulfill(e)}),r.promise}})(this);