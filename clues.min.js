/**
  * clues.js (c) 2009-2013 Ziggy.jonsson.nyc@gmail.com
  * @license MIT
  */
(function(e){function t(e,n){return this instanceof t?(this.logic=e||("undefined"==typeof window?{}:window),this.facts=n||{},void 0):new t(e,n)}function n(e){var t=i.exec(""+e.prototype.constructor);return t[1].replace(/\s/g,"").split(",")}var r;"undefined"!=typeof module?(r=require("q"),module.exports=t):(r=e.Q,e.clues=t),t.version="0.0.2";var i=/function.*?\((.*?)\).*/;t.prototype.solve=function(e,t){return this._solve(e,t)},t.prototype._solve=function(e,t){var r,i=this,o=i.adapter,f=o.pending();if(t=t||{},"function"!=typeof e){if(t[e])return o.fulfilled(t[e]);if(i.facts[e])return o.fulfilled(i.facts[e]);if(!i.logic[e])return o.rejected({ref:e,err:"not defined"});if("function"!=typeof i.logic[e])return o.fulfilled(i.logic[e]);i.facts[e]=f.promise,f.promise.then(function(t){i.facts[e]=t}),r=i.logic[e]}else r=e,e=null;var l={local:t,facts:i.facts,fulfill:f.fulfill,reject:function(t){return f.reject({ref:e,err:t})},callback:function(e,t){e?f.reject(e):f.fulfill(t)}};l.resolve=l.success=l.fulfill,l.error=l.reject;var u=n(r).filter(function(e){return e.length}).map(function(e){return"all"==e?i.all():l[e]||i.solve(e,t)});return this.join(u).then(function(){var e=r.apply(l,u);void 0!==e&&f.fulfill(e)},function(e){f.reject(e)}),f.promise},t.prototype.all=function(e){var t,n=this;return t=Object.keys(n.logic).map(function(t){return n.solve(t,e)}),n.join.call(this,t).then(function(){return n.facts})},t.prototype.as=function(e){var t=this,n=t.adapter.pending();return t.facts[e]=n.promise,function(r,i){r?n.reject(r):n.fulfill(i),t.facts[e]=i}},"undefined"!==r&&(t.prototype.adapter={fulfilled:r.resolve,rejected:r.reject,pending:function(){var e=r.defer();return{promise:e.promise,fulfill:e.resolve,reject:e.reject}}}),t.prototype.join=function(e){var t=e.length,n=this.adapter.pending();return t||n.fulfill([]),e.forEach(function(r,i){return r.then?(r.then(function(r){return e[i]=r,!(t-=1)&&n.fulfill(e)},function(e){n.reject(e)}),void 0):!(t-=1)&&n.fulfill(e)}),n.promise}})(this);