/**
  * clues.js (c) 2009-2013 Ziggy.jonsson.nyc@gmail.com
  * @license MIT
  */
(function(e){function t(e,r){return this instanceof t?(this.logic=e||("undefined"==typeof window?{}:window),this.facts=r||{},void 0):new t(e,r)}function r(e){if(e.__args__)return e.__args__;var t=i.exec(""+e.prototype.constructor);return e.__args__=t[1].replace(/\s/g,"").split(",")}var n;"undefined"!=typeof module?(n=require("q"),module.exports=t):(n=e.Q,e.clues=t),t.version="1.0.1";var i=/function.*?\((.*?)\).*/;t.prototype.solve=function(e,t,n){var i,l=this,f=l.adapter,o=f.pending();if(t=t||{},"function"!=typeof e){if(i=e,t[i])return f.fulfilled(t[i]);if(void 0!==l.facts[i])return f.fulfilled(l.facts[i]);if(void 0===l.logic[i])return n?f.fulfilled(null):f.rejected({ref:i,err:"not defined"});if("function"!=typeof l.logic[i])return f.fulfilled(l.logic[i]);l.facts[i]=o.promise,o.promise.then(function(e){l.facts[i]=e}),e=l.logic[i]}var u={ref:i,self:l,local:t,facts:l.facts,promise:o.promise,fulfill:o.fulfill,reject:o.reject,callback:function(e,t){e?o.reject(e):o.fulfill(t)}};u.resolve=u.success=u.fulfill,u.error=u.reject;var c=r(e).filter(function(e){return e.length}).map(function(e){return"all"==e?l.all():u[e]?u[e]:"_"===e[0]?l.solve(e.slice(1),t,!0):l.solve(e,t)});return this.join(c).then(function(){var t=l.wrap.call(u,e,c);void 0!==t&&(t.then?t.then(o.fulfill,o.reject):o.fulfill(t))}).then(null,function(e){o.reject(e)}),o.promise.then(null,function(e){throw e.err||(e={ref:i,err:e}),e})},t.prototype.wrap=function(e,t){return e.apply(this,t)},t.prototype.all=function(e){var t,r=this;return t=Object.keys(r.logic).map(function(t){return r.solve(t,e)}),r.join.call(this,t).then(function(){return r.facts})},t.prototype.as=function(e){var t=this,r=t.adapter.pending();return t.facts[e]=r.promise,function(n,i){n?r.reject(n):r.fulfill(i),t.facts[e]=i}},"undefined"!==n&&(t.prototype.adapter={fulfilled:n.resolve,rejected:n.reject,pending:function(){var e=n.defer();return{promise:e.promise,fulfill:e.resolve,reject:e.reject}}}),t.prototype.join=function(e){var t=e.length,r=this.adapter.pending();return t||r.fulfill([]),e.forEach(function(n,i){return n.then?(n.then(function(n){return e[i]=n,!(t-=1)&&r.fulfill(e)},r.reject),void 0):!(t-=1)&&r.fulfill(e)}),r.promise}})(this);