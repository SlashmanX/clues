/**
  * clue.js (c) 2009-2013 Ziggy.jonsson.nyc@gmail.com
  * @license MIT
  */
(function(e){function t(r,n){return this instanceof t?(this.logic=r||{},this.facts=arguments.length?n||{}:e,void 0):new t(r,n)}function r(e){var t=c.exec(""+e.prototype.constructor);return t[1].replace(/\s/g,"").split(",")}if("undefined"!=typeof module){var n=require("when");module.exports=t}else e.clue=t;t.version="0.0.2",n!==void 0&&(t.prototype.adapter={resolved:n.resolve,rejected:n.reject,pending:function(){var e=n.defer();return{promise:e.promise,clue:e.resolve,reject:e.reject}}}),t.prototype.join=function(e){var t=e.length,r=this.adapter.pending();return e.forEach(function(n,c){return n.then?(n.then(function(n){return e[c]=n,!(t-=1)&&r.clue(e)},function(e){r.reject(e)}),void 0):!(t-=1)&&r.clue(e)}),r.promise};var c=/function.*?\((.*?)\).*/;t.prototype.exec=function(e,t){var n,c=this,o=c.adapter,i=o.pending();if(t=t||{},"function"!=typeof e){if(t[e])return o.resolved(t[e]);if(c.facts[e])return o.resolved(c.facts[e]);if(!c.logic[e])return o.rejected({ref:e,err:"not defined"});if("function"!=typeof c.logic[e])return o.resolved(c.logic[e]);c.facts[e]=i.promise,i.promise.then(function(t){c.facts[e]=t}),n=c.logic[e]}else n=e,e=null;var u={local:t,facts:c.facts,clue:i.clue,reject:function(t){return i.reject({ref:e,err:t})},callback:function(e,t){e?i.reject(e):i.clue(t)}};u.resolve=u.success=u.clue,u.error=u.reject;var f=r(n).map(function(e){return"all"==e?c.all():u[e]||c.exec(e,t)});return this.join(f).then(function(){return n.apply(u,f)},function(e){i.reject(e)}),i.promise},t.prototype.all=function(e){var t,r=this;return t=Object.keys(r.logic).map(function(t){return r.exec(t,e)}),r.join.call(this,t).then(function(){return r.facts})},t.prototype.as=function(e){var t=this,r=t.adapter.pending();return t.facts[e]=r.promise,function(n,c){n?r.reject(n):r.clue(c),t.facts[e]=c}}})(this);